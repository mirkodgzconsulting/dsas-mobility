---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header';
import Footer from '../components/Footer';
import VehicleCard from '../components/VehicleCard';

import { supabase } from '../lib/supabase';
import OffersCarousel from '../components/OffersCarousel';
import FiltersSidebar from '../components/FiltersSidebar';

// Fetch LONG TERM Vehicles (exclude short term)
const { data: vehiclesData } = await supabase
    .from('veicoli')
    .select('*')
    .not('noleggio_breve', 'eq', true) // Equivalent to noleggio_breve != true
    .order('created_at', { ascending: false });

// Extract unique Brands and Categories for filters
const UNIQUE_BRANDS = [...new Set(vehiclesData?.map(v => v.marca).filter(Boolean))].sort();
const UNIQUE_CATEGORIES = [...new Set(vehiclesData?.map(v => v.categoria).filter(Boolean))].sort();

// Update RENTAL_VEHICLES map to include 'category' for filtering
const RENTAL_VEHICLES = vehiclesData?.map(v => ({
    brand: v.marca,
    model: v.modello,
    version: v.versione || '',
    price: v.canone_mensile || 0,
    image: v.immagine_url || 'https://via.placeholder.com/800x600?text=No+Image',
    fuel: v.alimentazione || 'N/A',
    transmission: v.cambio || 'N/A',
    available: v.tempo_consegna === 'Pronta Consegna',
    category: v.categoria // Essential for filtering
})) || [];

import Catalog from '../components/Catalog';
---

<Layout>
	<Header client:load /> 
	
	<main class="bg-gray-50 min-h-screen pb-16 pt-10">
        
        {/* CATALOG SECTION - SPLIT LAYOUT */}
        <div class="py-8">
            <div class="container-custom">
                {/* Catalog Header */}
                <div class="text-center mb-16">
                     <h1 class="text-3xl md:text-5xl font-bold uppercase tracking-tight text-primary">
                        NOLEGGIO <span class="text-secondary">LUNGO TERMINE</span>
                     </h1>

                </div>

                {/* Interactive Catalog Component */}
                <Catalog 
                    client:load 
                    initialVehicles={RENTAL_VEHICLES} 
                    brands={UNIQUE_BRANDS} 
                    categories={UNIQUE_CATEGORIES} 
                />

            </div>
        </div>
    </main>
    <Footer />
</Layout>

